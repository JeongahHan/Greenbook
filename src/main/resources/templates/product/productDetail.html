<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="UTF-8">
<title>상세보기</title>
<link rel="stylesheet" href="/css/productDefault.css">
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@48,400,1,0" />
<link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
<link rel="stylesheet" href="/css/productDetail.css">
<script src="/javascript/jquery-3.7.0.js"></script>
</head>
<body>

	<th:block th:include="common/header"></th:block>
	
	<div class="main">
        <div class="main-wrap">

            <!-- 최신게시물 / 상품리스트 -->
            <div class="main-mid">
                
                <div class="mid-content">
                
	                <div class="img-box">
						<img th:src="${p.productFile.getFilepath}">
					</div>
					
					<div class="profile-box">
						<div class="box1">
							<span class="material-symbols-outlined userMainImage">account_circle</span>
							<span class="ProductBoardWriter" th:text="${p.getProductBoardWriter}"></span>
						</div>
						
						<div class="box2">
							<span class="Grade">신뢰도 <span>1123</span></span>
						</div>
					</div>
					
					<div class="main-box">
						<div class="title" th:text="${p.getProductBoardTitle}"></div>
						
						<div class="cart"><a class="cart-btn">찜하기</a></div>
						<div class="buy"><a class="buy-btn">구매하기</a></div>
						<div class="author" th:text="${p.getProductAuthor}"></div>
						<div class="price"><span th:text="${p.getProductPrice}"></span> 원</div>
						<div class="content" th:utext="${p.getProductBoardContent}"></div>
						<div class="readCount">조회수 <span th:text="${p.getReadCount}"></span></div>
						<a class="update" th:if="${session.m != null && session.m.memberId == p.productBoardWriter}">수정</a>
						<button class="delete" th:if="${session.m != null && session.m.memberId == p.productBoardWriter}">삭제</button>
					</div>
					
					<!-- 댓글 입력 -->
					<div class="comment-box" th:if="${session.m != null}"> <!-- th:if="${session.m != null}" -->
						<form action="/product/insertComment" method="post">
							<ul>
								<li>
									<span class="material-symbols-outlined userMainImage">account_circle</span>
								</li>
								<li>
									<input type="hidden" name="productCommentWriter" th:value="${session.m.memberId}">
									<input type="hidden" name="productRef" th:value="${p.productBoardNo}">
									<textarea name="productCommentContent" class="commentInput-form"></textarea>
								</li>
								<li>
									<button type="submit" class="btn bc1 bs4 commentInsert">등록</button>
								</li>
							</ul>
						</form>
					</div>
					
					<!-- 댓글 출력 -->
					<div class="comment-list-box">
						<th:block th:each="pc : ${commentList}">
						
							<ul class="posting-comment">
								<li>
									<span class="material-symbols-outlined userMainImage">account_circle</span>
								</li>
								<li>
									<p class="comment-info">
										<span th:text="${pc.productCommentWriter}"></span>
										<span th:text="${pc.productCommentDate}"></span>
									</p>
									<p class="comment-content" th:text="${pc.productCommentContent}"></p>
									
									<!--  댓글 수정 -->
									<textarea name="productCommentContent" class="commentUpdateInput-form" style="min-height:96px; display:none;" th:text="${pc.productCommentContent}"></textarea>
									<p class="comment-link">
										<th:block th:if="${session.m != null}">
											<th:block>
												<a href="javascript:void(0);" th:onclick="modifyComment(this,[[${pc.productCommentNo}]],[[${p.productBoardNo}]])" th:if="${session.m.memberId == pc.productCommentWriter}">수정</a>
												<a href="javascript:void(0);" th:onclick="deleteComment(this,[[${pc.productCommentNo}]],[[${p.productBoardNo}]])" th:if="${session.m.memberId == pc.productCommentWriter || session.m.memberLevel == 1}">삭제</a>
											</th:block>
											<a href="javascript:void(0);" class="recShow" th:if="${session.m != null}">답글달기</a>
										</th:block>	
									</p>
								</li>
							</ul>
							
							<!-- 대댓글 출력 -->
							<th:block th:each="pcc : ${reCommentList}">
								<ul class="posting-comment reply" th:if="${pc.productCommentNo} == pcc.productCommentRef">
									<li>
										<span class="material-symbols-outlined">subdirectory_arrow_right</span>
										<span class="material-symbols-outlined userMainImage">account_circle</span>
									</li>
									<li>
										<p class="comment-info">
											<span th:text="${pcc.productCommentWriter}"></span>
											<span th:text="${pcc.productCommentDate}"></span>
										</p>
										<p class="comment-content" th:text="${pcc.productCommentContent}"></p>
										
										<!-- 대댓글 수정 -->
										<textarea name="productCommentContent" class="commentUpdateInput-form" style="min-height:96px; display:none;" th:text="${pcc.productCommentContent}"></textarea>
										
										<p class="comment-link">
											<th:block th:if="${session.m != null}">
												<th:block>
													<a href="javascript:void(0);" th:onclick="modifyComment(this,[[${pcc.productCommentNo}]],[[${p.productBoardNo}]])" th:if="${session.m.memberId == pcc.productCommentWriter}">수정</a>
													<a href="javascript:void(0);" th:onclick="deleteComment(this,[[${pcc.productCommentNo}]],[[${p.productBoardNo}]])" th:if="${session.m.memberId == pcc.productCommentWriter || session.m.memberLevel == 1}">삭제</a>
												</th:block>
											</th:block>	
										</p>
									</li>
								</ul>
							</th:block>
							
							<!-- 대댓글 등록 -->
							<div class="inputCommentBox inputRecommentBox" th:if="${session.m != null}">
								<form action="/product/insertComment" method="post">
									<ul>
										<li>
											<span class="material-symbols-outlined">subdirectory_arrow_right</span>
										</li>
										<li>
											<input type="hidden" name="productCommentWriter" th:value="${session.m.memberId}">
											<input type="hidden" name="productRef" th:value="${p.productBoardNo}">
											<input type="hidden" name="productCommentRef" th:value="${pc.productCommentNo}">
											<textarea name="productCommentContent" class="commentInput-form"></textarea>
										</li>
										<li>
											<button type="submit" class="btn bc1 bs4 commentInsert">등록</button>
										</li>
									</ul>
								</form>
							</div>
							
						</th:block>	
					</div>
					
                </div>
                
            </div>

        </div>
    </div>
	
		
		
	<th:block th:include="common/footer"></th:block>

	<script>
	
		$(".cart").on("click",function(){
			const result = confirm("찜목록에 등록하시겠습니까?");
			if(result){
				alert("성공");
			}
		});
		
		$(".buy").on("click",function(){
			const result = confirm("구매하시겠습니까?");
			if(result){
				alert("판매자에게 메세지를 전송하였습니다.");
			}
		});
		
		$(".update").on("click",function(){
			const result = confirm("게시물을 수정하시겠습니까?");
			if(result){
				alert("성공");
			}
		});
		
		$(".delete").on("click",function(){
			const result = confirm("삭제하시겠습니까?");
			if(result){
				alert("성공");
			}
		});
		
		
		$(".commentInsert").on("click",function(){
			const result = confirm("댓글을 등록하시겠습니까??");
			if(result){
				
			}
		});
		
		// 댓글 수정
		function modifyComment(obj, productCommentNo, productBoardNo){
			// 현재 보이는 p태그 숨기기
			$(obj).parent().prev().prev().hide();
			
			// 숨겨져있는 textarea 보여주기
			$(obj).parent().prev().show();
			
			// 수정 -> 수정완료로 바꾸기(이벤트도 수정완료 이벤트로 변경)
			$(obj).text("수정완료");
			$(obj).attr("onclick","modifyComplete(this,"+productCommentNo+","+productBoardNo+")");
			
			// 삭제 -> 수정취소로 바꾸기(이벤트도 수정취소 이벤트로 변경)
			$(obj).next().text("수정취소");
			$(obj).next().attr("onclick","modifyCancel(this,"+productCommentNo+","+productBoardNo+")");
			
			// 답글달기 버튼 숨기기
			$(obj).next().next().hide();
		}
		
		// 댓글 수정 취소
		function modifyCancel(obj, productCommentNo, productBoardNo){
			// 숨어있는 p태그를 보여줆(위와 반대)
			$(obj).parent().prev().prev().show();
			
			// 보이는 textarea를 숨긺(위와 반대)
			$(obj).parent().prev().hide();
			
			// 수정완료 -> 수정으로 바꾸기(이벤트도 변경)
			$(obj).prev().text("수정");
			$(obj).prev().attr("onclick","modifyComment(this,"+productCommentNo+","+productBoardNo+")");
			
			// 수정취소 -> 삭제로 바꾸기(이벤트도 변경)
			$(obj).text("삭제");
			$(obj).attr("onclick","deleteComment(this,"+productCommentNo+","+productBoardNo+")");
			
			// 답글달기 다시 보여줌
			$(obj).next().show();
		}
		
		// 댓글 수정 완료
		function modifyComplete(obj, productCommentNo, productBoardNo){
			if(confirm("댓글을 수정하시겠습니까?")){
			// javascript에서 form태그를 생성해서 데이터를 넣어서 전송
			// 보내야할 값 -> 수정한 댓글 내용(textarea), 댓글번호(where), 공지사항번호(완료 후 다시 이 번호의 페이지로)
			
			// 1. form태그 생성
			const form = $("<form style='display:none' action='/product/updateComment' method='post'>");
			
			// 2. input태그 생성해서 댓글번호, 공지사항번호 넣기
			const commentNoInput = $("<input type='text' name='productCommentNo'>");
			commentNoInput.val(productCommentNo);
			const productNoInput = $("<input type='text' name='productRef'>");
			productNoInput.val(productBoardNo);
			
			// 3. 변경한 내용이 들어있는 textarea
			const textArea = $(obj).parent().prev().clone();
			
			// 4. form태그 내부에 input 2개와 textarea태그를 포함
			form.append(commentNoInput).append(productNoInput).append(textArea);
			
			// 5. 완성된 form태그를 body에 추가
			$("body").append(form);
			
			// 6. form submit
			form.submit();
			}
		}
		
		// 댓글 삭제
		function deleteComment(obj, productCommentNo, productBoardNo){
			if(confirm("댓글을 삭제하시겠습니까?")){
				location.href="/product/deleteComment?productCommentNo="+productCommentNo+"&productBoardNo="+productBoardNo;
			}
		}
		
		// 대댓글
		$(".recShow").on("click",function(){
			// 몇번째 답글달기 버튼을 클릭한지 구하기
			const index = $(".recShow").index(this);
			if($(this).text() == "답글달기"){
				$(this).text("취소");
			}else{
				$(this).text("답글달기");
			}
			
			// 대댓글 양식 중에 해당번째 양식을 화면에 출력
			$(".inputRecommentBox").eq(index).toggle();
			$(".inputRecommentBox").eq(index).find("textarea").focus();
		});
	
	</script>
</body>
</html>